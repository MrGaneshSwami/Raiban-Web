
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Return Stock - Raiban Electrical Solutions</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Global CSS -->
  <link href="style.css" rel="stylesheet">

  <style>
    .alert-custom-error {
        background: #fbeaff;        
        border-left: 6px solid #9b59b6;  
        color: #4a235a;             
        padding: 10px 14px;
        border-radius: 6px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin-top: 5px;
    }
    /* make sure suggestion boxes appear above other content */
    .list-group.position-absolute { z-index: 9999; max-height: 220px; overflow:auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="ajax.js"></script>
</head>
<body>
  <!-- Header Placeholder -->
  <div id="header-placeholder"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      fetch("header.html")
        .then(response => response.text())
        .then(data => {
          document.getElementById("header-placeholder").innerHTML = data;
        });
    });
  </script>

  <!-- Page Content -->
  <div class="container my-5">

    <!-- Header Row -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <a href="Store_dashboard.php" class="btn btn-dark">
        <i class="fas fa-arrow-left me-2"></i> Back
      </a>
      <h2 class="page-title m-0 text-center flex-grow-1">
        <i class="fas fa-undo me-2"></i> Return Stock
      </h2>
    </div>

    <!-- Return Form Card -->
    <div class="form-card p-4 shadow rounded-3">
      <form id="returnForm" action="return_stock.php" method="POST">
  
        <!-- Store Incharge + Site Name -->
        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user-tie me-2"></i>Store Incharge</label>
            <input type="text" class="form-control" name="storeIncharge" id="storeIncharge" placeholder="Enter Store Incharge Name" required autocomplete="off">
            <div id="storeInchargeSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-building me-2"></i>Site Name</label>
            <input type="text" class="form-control" name="siteName" id="siteName" placeholder="Enter Site Name" required autocomplete="off">
            <div id="siteNameSuggestions" class="list-group position-absolute w-100"></div>
          </div>
        </div>

        <!-- Site Incharge + Supervisor -->
        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user-check me-2"></i>Site Incharge</label>
            <input type="text" class="form-control" name="siteIncharge" id="siteIncharge" placeholder="Enter Site Incharge Name" autocomplete="off">
            <div id="siteInchargeSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user-cog me-2"></i>Site Supervisor</label>
            <input type="text" class="form-control" name="siteSupervisor" id="siteSupervisor" placeholder="Enter Site Supervisor Name" required autocomplete="off">
            <div id="siteSupervisorSuggestions" class="list-group position-absolute w-100"></div>
          </div>
        </div>

        <!-- Contractor + Circle -->
        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user me-2"></i>Contractor Name</label>
            <input type="text" class="form-control" name="contractor" id="contractor" placeholder="Enter Contractor Name" required autocomplete="off">
            <div id="contractorSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-circle me-2"></i>Name of Circle</label>
            <input type="text" class="form-control" name="circle" id="circle" placeholder="Enter Name of Circle" required>
          </div>
        </div>

        <!-- Division + Sub Division -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-building me-2"></i>Name of Division</label>
            <input type="text" class="form-control" name="division" id="division" placeholder="Enter Name of Division" required>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-sitemap me-2"></i>Name of Sub Division</label>
            <input type="text" class="form-control" name="subDivision" id="subDivision" placeholder="Enter Name of sub division" required>
          </div>
        </div>

        <!-- Section + Location -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-layer-group me-2"></i>Name of Section</label>
            <input type="text" class="form-control" name="sectionName" id="sectionName" placeholder="Enter Name of Section" required>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-map-marker-alt me-2"></i> Location</label>
            <input type="text" class="form-control" name="location" id="location" placeholder="Enter Location" required>
          </div>
        </div>

        <!-- Material Details -->
        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-barcode me-2"></i>Material Code</label>
            <input type="text" class="form-control" id="materialCode" placeholder="Enter Material Code" autocomplete="off">
            <div id="materialCodeSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-box me-2"></i>Material Name</label>
            <input type="text" class="form-control" id="materialName" placeholder="Enter Material Name" autocomplete="off">
            <div id="materialNameSuggestions" class="list-group position-absolute w-100"></div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-ruler me-2"></i>Material Unit</label>
            <input type="text" class="form-control" id="materialUnit" placeholder="Enter Material Unit" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-hashtag me-2"></i>Return Quantity</label>
           <input type="number" class="form-control" id="quantity" placeholder="Enter Quantity">
          </div>
        </div>   
  
  <div class="row mb-3">
    <div class="col-md-6">
    <label class="form-label"><i class="fas fa-fire me-2"></i>Consumed Qty</label>
    <input type="number" class="form-control" id="consumedQty" placeholder="Enter Consumed Quantity">
  </div>
<input type="hidden" id="currentSiteStock" value="0">
<div class="col-md-6">
<label class="form-label"><i class="fas fa-dollar-sign me-2"></i>Price (At Issue Time)</label>
<input type="number" class="form-control" id="price" name="price" placeholder="Enter Price">
</div>
</div>

          <div class="row mb-3">
          <div class="col-md-12">
            <label class="form-label"><i class="fas fa-comment-dots me-2"></i>Remark</label>
            <input type="text" name="reason" class="form-control" placeholder="Enter Remark" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12 d-flex flex-column">
            <div id="normalItemError"></div>
            <button type="button" id="addNormalBtn" class="btn btn-success w-100">
              <i class="fas fa-plus-circle me-2"></i> Add Item
            </button>
          </div>
        </div>

        <!-- Scrap Section -->
        <h5 class="page-title m-3 text-center flex-grow-1">!--- Scrap Section ---!</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-recycle me-2"></i> Scrap Type</label>
            <select class="form-control" id="scarptype">
              <option value="">-- Select Scrap Type --</option>
              <option value="Iron">Iron</option>
              <option value="Copper">Copper</option>
              <option value="Wood">Wood</option>
              <option value="Aluminium">Aluminum</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-hashtag me-2"></i>Scrap Quantity</label>
            <input type="number" class="form-control" id="scrapQuantity" name="scrapQuantity" placeholder="Enter Scrap Quantity">
          </div>
        </div>

        <!-- Recycle Section -->
        <h5 class="page-title m-3 text-center flex-grow-1">!-- Recycle Stock Section --!</h5>
        <div class="row mb-3">
          <div class="col-md-3 position-relative">
            <label class="form-label"><i class="fas fa-barcode me-2"></i>Recycle Material Code</label>
            <input type="text" class="form-control" id="recycleMaterialCode" name="recycleMaterialCode" placeholder="Enter Recycle Material Code">
            <input type="hidden" id="recycleProductId" name="recycleProductId">
            <div id="recycleMaterialCodeSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-3 position-relative">
            <label class="form-label"><i class="fas fa-box me-2"></i>Recycle Material Name</label>
            <input type="text" class="form-control" id="recycleMaterialName" name="recycleMaterialName" placeholder="Enter Recycle Material Name">
            <div id="recycleMaterialNameSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-3">
            <label class="form-label"><i class="fas fa-ruler me-2"></i> Recycle Material Unit</label>
            <input type="text" class="form-control" id="recycleMaterialUnit" placeholder="Enter Recycle Material Unit">
          </div>
          <div class="col-md-3">
            <label class="form-label"><i class="fas fa-hashtag me-2"></i>Recycle Material Quantity</label>
            <input type="number" class="form-control" id="recycleMaterialQuantity" name="recycleMaterialQuantity" placeholder="Enter Recycle Quantity">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-dollar-sign me-2"></i>Price (At Issue Time)</label>
            <input type="number" class="form-control" id="recyclePrice" name="recyclePrice" placeholder="Enter Price" >
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-12 d-flex flex-column">
            <div id="RecycleItemError"></div>
            <button type="button" id="addScrapBtn" class="btn btn-success w-100">
              <i class="fas fa-plus-circle me-2"></i> Add Item
            </button>
          </div>
        </div>

        <!-- Items Tables -->
        <h5 class="page-title m-3 text-center flex-grow-1">
          <i class="fas fa-undo me-2"></i> Return Stock
        </h5>
       <table class="table table-bordered text-center" id="itemsTable">
  <thead class="table-light">
    <tr>
      <th>Sr.No</th>
      <th>Material Code</th>
      <th>Material Name</th>
      <th>Unit</th>
      <th>Return Quantity</th>
      <th>Consumed Quantity</th> <!-- NEW -->
      <th>Price</th>
      <th>Remark</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

                 
        <!-- Normal Items Final Cost -->
          <div class="mb-3 text-end">
              <h5>Final Cost: ₹<span id="finalCostNormal">0.00</span></h5>
          </div>
         <input type="hidden" name="itemsData" id="itemsData">

        <!-- Scrap & Recycle Table -->
        <h5 class="page-title m-3 text-center flex-grow-1">
          <i class="fas fa-recycle me-2"></i> Recycle Material
        </h5>
        <table class="table table-bordered text-center" id="scrapTable">
          <thead class="table-light">
            <tr>
              <th>Sr.No</th>
              <th>Material Code</th>
              <th>Material Name</th>
              <th>Unit</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Remark</th>
              <th>Remove</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="mb-3 text-end">
          <h5>Final Cost (Recycle Items): ₹<span id="finalCostRecycle">0.00</span></h5>
        </div>

        <input type="hidden" name="scrapData" id="scrapData">

        <div class="col-12 text-center mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i> Save Return
          </button>
        </div>

        <div id="successMessage" class="alert alert-success d-none mt-3" role="alert">
          ✅ Return successfully recorded!
        </div>

      </form>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- optional external script.js (if you use it) -->
  <script src="script.js"></script>
  <script src="ajax.js"></script>

  <script>
 
    document.addEventListener("DOMContentLoaded", function() {
      // --- Setup autocompletes (ajax.js must implement setupAutocomplete) ---
      setupAutocomplete("siteName", "siteNameSuggestions", "site_name");
      setupAutocomplete("materialCode", "materialCodeSuggestions", "material_code");
      setupAutocomplete("materialName", "materialNameSuggestions", "material_name");
      setupAutocomplete("recycleMaterialCode", "recycleMaterialCodeSuggestions", "material_code");
      setupAutocomplete("recycleMaterialName", "recycleMaterialNameSuggestions", "material_name");

      // Fill related site details when site name clicked
      document.getElementById("siteNameSuggestions").addEventListener("click", function(e) {
        const siteName = e.target.dataset.value || e.target.textContent;
        fetch(`fetch_suggestions.php?field=site_details_by_name&q=${encodeURIComponent(siteName)}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              document.getElementById("siteSupervisor").value = data.siteSupervisor || "";
              document.getElementById("siteIncharge").value = data.siteIncharge || "";
              document.getElementById("contractor").value = data.contractor || "";
              document.getElementById("division").value = data.division || "";
              document.getElementById("subDivision").value = data.subDivision || "";
              document.getElementById("sectionName").value = data.sectionName || "";
              document.getElementById("circle").value = data.circle || "";
              document.getElementById("location").value = data.location || "";
            }
          });
      });


      

      // === Data arrays ===
      let normalItems = [];
      let scrapRecycleItems = [];

      function showButtonErrorPopup(message) {
        Swal.fire({ icon: 'error', title: 'Error', text: message, confirmButtonColor: '#6366F1', confirmButtonText: 'OK' });
      }

      function clearErrors(containerId) { document.getElementById(containerId).innerHTML = ""; }

      // Add normal item
   document.getElementById("addNormalBtn").addEventListener("click", () => {
  clearErrors("normalItemError");
  const code   = document.getElementById("materialCode").value.trim();
  const name   = document.getElementById("materialName").value.trim();
  const unit   = document.getElementById("materialUnit").value.trim();
  const qty    = parseFloat(document.getElementById("quantity").value.trim());
  const consumedQty = parseFloat(document.getElementById("consumedQty").value.trim()) || 0;
  const rate   = parseFloat(document.getElementById("price").value.trim());
  const remark = document.querySelector("input[name='reason']").value.trim();

  const siteStock = parseFloat(document.getElementById("currentSiteStock").value) || 0;

  if (!code || !name || !unit || isNaN(qty) || qty < 0 || isNaN(rate)) {
    showButtonErrorPopup("Please fill at least material code, name, unit, quantity and price.");
    return;
  }
  
  if ((qty + consumedQty) > siteStock) {
    showButtonErrorPopup(`Return + Consumed (${qty+consumedQty}) exceeds available site stock (${siteStock}).`);
    return;
  }

  const total = qty * rate;
  normalItems.push({ code, name, unit, qty, consumedQty, rate, total, remark });
  renderNormalItems();
  clearNormalItemInputs();
  document.getElementById("itemsData").value = JSON.stringify(normalItems);
  updateFinalCost();
});



      // Add scrap/recycle item
      document.getElementById("addScrapBtn").addEventListener("click", () => {
        clearErrors("RecycleItemError");
        const scrapType    = document.getElementById("scarptype").value.trim();
        const scrapQtyRaw  = document.getElementById("scrapQuantity").value.trim();
        const scrapQty     = parseFloat(scrapQtyRaw);
        const recycleCode  = document.getElementById("recycleMaterialCode").value.trim();
        const recycleName  = document.getElementById("recycleMaterialName").value.trim();
        const recycleUnit  = document.getElementById("recycleMaterialUnit").value.trim();
        const recycleQtyRaw= document.getElementById("recycleMaterialQuantity").value.trim();
        const recycleQty   = parseFloat(recycleQtyRaw);
        const rateRaw      = document.getElementById("recyclePrice").value.trim();
        const rate         = parseFloat(rateRaw);
        const remark       = document.querySelector("input[name='reason']").value.trim();

        // At least one of scrapType+scrapQty OR recycleCode+recycleQty must be present
        if ((!scrapType || isNaN(scrapQty) || scrapQty < 0) && (!recycleCode || isNaN(recycleQty) || recycleQty < 0)) {
          showButtonErrorPopup("Please fill scrap type & quantity OR recycle material code & quantity.");
          return;
        }
        if (isNaN(rate)) {
          showButtonErrorPopup("Please provide a price for recycle/scrap item.");
          return;
        }

        // use whichever quantity is present
        const finalQty = (!isNaN(scrapQty) && scrapQty > 0) ? scrapQty : recycleQty;
        const total = finalQty * rate;

        scrapRecycleItems.push({ scrapType, scrapQty, recycleCode, recycleName, recycleUnit, recycleQty, rate, total, remark });
        renderScrapRecycleItems();
        clearScrapRecycleInputs();
        document.getElementById("scrapData").value = JSON.stringify(scrapRecycleItems);
        updateFinalCost();
      });

      // Render functions
      function renderNormalItems() {
        const tbody = document.querySelector("#itemsTable tbody");
        tbody.innerHTML = "";
        normalItems.forEach((item, i) => {
          tbody.innerHTML += `
            <tr>
              <td>${i+1}</td>
              <td>${item.code}</td>
              <td>${item.name}</td>
              <td>${item.unit}</td>
              <td>${item.qty}</td>
              <td>${item.consumedQty}</td>
              <td>${item.rate.toFixed(2)}</td>
              <td>${item.remark || '-'}</td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeNormalItem(${i})"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
      }

      window.removeNormalItem = function(i) {
        normalItems.splice(i,1);
        renderNormalItems();
        document.getElementById("itemsData").value = JSON.stringify(normalItems);
        updateFinalCost();
      }

      function renderScrapRecycleItems() {
        const tbody = document.querySelector("#scrapTable tbody");
        tbody.innerHTML = "";
        scrapRecycleItems.forEach((item, i) => {
          tbody.innerHTML += `
            <tr>
              <td>${i+1}</td>
              <td>${item.recycleCode || '-'}</td>
              <td>${item.recycleName || '-'}</td>
              <td>${item.recycleUnit || '-'}</td>
              <td>${item.recycleQty || '-'}</td>
              <td>${item.rate.toFixed(2)}</td>
              <td>${item.remark || '-'}</td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="removeScrapRecycleItem(${i})"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
      }

      window.removeScrapRecycleItem = function(i) {
        scrapRecycleItems.splice(i,1);
        renderScrapRecycleItems();
        document.getElementById("scrapData").value = JSON.stringify(scrapRecycleItems);
        updateFinalCost();
      }

      function clearNormalItemInputs() {
        ["materialCode","materialName","materialUnit","quantity","price"].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
      }

      function clearScrapRecycleInputs() {
        ["scarptype","scrapQuantity","recycleMaterialCode","recycleMaterialName","recycleMaterialUnit","recycleMaterialQuantity","recyclePrice"].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = ""; });
      }

      function updateFinalCost() {
        let normalTotal = normalItems.reduce((sum, item) => sum + (item.total || 0), 0);
        let scrapTotal  = scrapRecycleItems.reduce((sum, item) => sum + (item.total || 0), 0);

        document.getElementById("finalCostNormal").textContent = normalTotal.toFixed(2);
        document.getElementById("finalCostRecycle").textContent = scrapTotal.toFixed(2);
      }

      function scrollToElement(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }

      // === Autocomplete selection handlers that fill unit & price ===
      document.getElementById("materialCodeSuggestions").addEventListener("click", function(e) {
        const code = e.target.dataset.value || e.target.textContent;
        fetch(`fetch_suggestions.php?field=material_name_by_code&q=${encodeURIComponent(code)}`)
          .then(res => res.text())
          .then(name => { document.getElementById("materialName").value = name; });

        fetch(`fetch_suggestions.php?field=material_unit_by_code&q=${encodeURIComponent(code)}`)
          .then(res => res.text())
          .then(unit => { document.getElementById("materialUnit").value = unit; });

        // Price at issue time (site-specific)
        const currentSiteForCode = document.getElementById("siteName").value.trim();
        fetch(`fetch_suggestions.php?field=issued_rate_by_site_and_code&q=${encodeURIComponent(code)}&site=${encodeURIComponent(currentSiteForCode)}`)
          .then(res => res.json())
          .then(data => { document.getElementById("price").value = data.rate || 0; });

        // Fetch current site stock for selected site and material code
        const currentSite = document.getElementById("siteName").value.trim();
        if (currentSite) {
          fetch(`fetch_suggestions.php?field=site_stock_by_code&q=${encodeURIComponent(code)}&site=${encodeURIComponent(currentSite)}`)
            .then(res => res.json())
            .then(data => { document.getElementById("currentSiteStock").value = data.stock || 0; });
        }
      });

      document.getElementById("materialNameSuggestions").addEventListener("click", function(e) {
        const name = e.target.dataset.value || e.target.textContent;
        fetch(`fetch_suggestions.php?field=material_code_by_name&q=${encodeURIComponent(name)}`)
          .then(res => res.text())
          .then(code => { document.getElementById("materialCode").value = code; });

        fetch(`fetch_suggestions.php?field=material_unit_by_name&q=${encodeURIComponent(name)}`)
          .then(res => res.text())
          .then(unit => { document.getElementById("materialUnit").value = unit; });

        // Price at issue time (by name, site-specific)
        const currentSiteForName = document.getElementById("siteName").value.trim();
        fetch(`fetch_suggestions.php?field=issued_rate_by_site_and_name&q=${encodeURIComponent(name)}&site=${encodeURIComponent(currentSiteForName)}`)
          .then(res => res.json())
          .then(data => { document.getElementById("price").value = data.rate || 0; });

        // Fetch current site stock for selected site and material name
        const currentSite = document.getElementById("siteName").value.trim();
        if (currentSite) {
          fetch(`fetch_suggestions.php?field=site_stock_by_name&q=${encodeURIComponent(name)}&site=${encodeURIComponent(currentSite)}`)
            .then(res => res.json())
            .then(data => { document.getElementById("currentSiteStock").value = data.stock || 0; });
        }
      });

      // Recycle selection -> fill recycle fields + price at issue time
      document.getElementById("recycleMaterialCodeSuggestions").addEventListener("click", function(e) {
        const code = e.target.dataset.value || e.target.textContent;
        fetch(`fetch_suggestions.php?field=material_name_by_code&q=${encodeURIComponent(code)}`)
          .then(res => res.text())
          .then(name => { document.getElementById("recycleMaterialName").value = name; });

        fetch(`fetch_suggestions.php?field=material_unit_by_code&q=${encodeURIComponent(code)}`)
          .then(res => res.text())
          .then(unit => { document.getElementById("recycleMaterialUnit").value = unit; });

        // Price at issue time
        fetch(`fetch_suggestions.php?field=issued_rate_by_code&q=${encodeURIComponent(code)}`)
          .then(res => res.json())
          .then(data => { document.getElementById("recyclePrice").value = data.rate || 0; });
      });

      document.getElementById("recycleMaterialNameSuggestions").addEventListener("click", function(e) {
        const name = e.target.dataset.value || e.target.textContent;
        fetch(`fetch_suggestions.php?field=material_code_by_name&q=${encodeURIComponent(name)}`)
          .then(res => res.text())
          .then(code => { document.getElementById("recycleMaterialCode").value = code; });

        fetch(`fetch_suggestions.php?field=material_unit_by_name&q=${encodeURIComponent(name)}`)
          .then(res => res.text())
          .then(unit => { document.getElementById("recycleMaterialUnit").value = unit; });

        // Price at issue time (by name)
        fetch(`fetch_suggestions.php?field=issued_rate_by_name&q=${encodeURIComponent(name)}`)
          .then(res => res.json())
          .then(data => { document.getElementById("recyclePrice").value = data.rate || 0; });
      });

    });
  </script>
</body>
</html>


