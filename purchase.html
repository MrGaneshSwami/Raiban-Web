<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Purchase - Raiban Electrical Solutions</title>
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Common Stylesheet -->
  <link rel="stylesheet" href="style.css"/>
   <style>
    
.list-group {
  max-height: 200px;
  overflow-y: auto;
  z-index: 1050; /* stays above form fields */
}

  </style>
</head>
<body>

  <!-- Header (Navbar will load here) -->
  <div id="header-placeholder"></div>

  <!-- Page Content -->
  <div class="container my-5">

    <!-- Header Row -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <a href="Store_dashboard.php" class="btn btn-dark">
        <i class="fas fa-arrow-left me-2"></i> Back
      </a>

      <h2 class="page-title m-0 text-center flex-grow-1">
        <i class="fas fa-box-open me-2"></i> Manage Purchases
      </h2>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="alert alert-success d-none text-center" role="alert">
      ✅ Purchase successfully recorded!
    </div>

    <!-- Purchase Form -->
    <div class="form-card">
      <form action="purchase.php" method="POST" id="purchaseForm">

        <!-- Supplier Details -->
        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user-tie me-2"></i> Store Incharge</label>
            <input type="text" class="form-control" id="storeIncharge" name="storeIncharge" autocomplete="off"  placeholder="Enter Store Incharge Name"   required>
            <div id="storeInchargeSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-user-tie me-2"></i> Supplier Name</label>
            <input type="text" class="form-control" id="supplierName" name="supplierName" autocomplete="off" placeholder="Enter Supplier Name"   required>
            <div id="supplierNameSuggestions" class="list-group position-absolute w-100"></div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6 position-relative">
            <label class="form-label"><i class="fas fa-file-invoice me-2"></i> Supplier GST No</label>
            <input type="text" class="form-control" id="supplierGst" name="supplierGst" autocomplete="off" placeholder="Enter Supplier GST No"  required>
            <div id="supplierGstSuggestions" class="list-group position-absolute w-100"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-phone me-2"></i> Contact No</label>
            <input type="text" class="form-control" id="contactNo" name="contactNo" placeholder="Enter Contact No"   required>
          </div>
        </div>

        <!-- Material Input Row -->
        <div id="materialInputs">
          <div class="row mb-3">
            <div class="col-md-6 position-relative">
              <label class="form-label"><i class="fas fa-box me-2"></i> Material Name</label>
              <input type="text" class="form-control" id="materialName" autocomplete="off"  placeholder="Enter Material Name"  >
              <div id="materialNameSuggestions" class="list-group position-absolute w-100"></div>
            </div>
            <div class="col-md-6 position-relative">
              <label class="form-label"><i class="fas fa-barcode me-2"></i> Material Code</label>
              <input type="text" class="form-control" id="materialCode" autocomplete="off" placeholder="Enter Material Code">
              <div id="materialCodeSuggestions" class="list-group position-absolute w-100"></div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-sort-numeric-up me-2"></i> Quantity</label>
              <input type="number" class="form-control" id="materialQuantity" placeholder="Enter Material Quantity">
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-ruler me-2"></i> Unit</label>
              <input type="text" class="form-control" id="materialUnit" placeholder="Enter Material Unit">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-map-marker-alt me-2"></i> Location</label>
              <input type="text" class="form-control" id="location" placeholder="Enter Location">
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-dollar-sign me-2"></i> Rate</label>
              <input type="number" step="1" class="form-control" id="rate" placeholder="Enter Rate">
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-receipt me-2"></i> GST (%)</label>
              <input type="number" step="0.01" class="form-control" id="gstPercent" placeholder="Enter GST">
            </div>
            <div class="col-md-6">
              <label class="form-label"><i class="fas fa-coins me-2"></i> Total Cost</label>
              <input type="number" class="form-control" id="totalCost"  placeholder="Total cost" readonly>
            </div>

        </div>

            
          <div class="row mb-3">
            <div class="col-md-12 d-flex align-items-end">
              <button type="button" id="addItemBtn" class="btn btn-success w-100">
                <i class="fas fa-plus-circle me-2"></i> Add Item
              </button>
            </div>
          </div>
        </div>

        <!-- Items Table -->
        <div class="table-responsive mb-3">
          <table class="table table-bordered text-center" id="itemsTable">
            <thead class="table-light">
              <tr>
                <th>Sr No</th>
                <th>Name</th>
                <th>Code</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Location</th>
                <th>Rate</th>
                <th>GST (%)</th>
                <th>GST Amount</th>
                <th>Total</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Payment + Final -->
        <div class="row mb-3">
         <div class="col-md-6">
            <label class="form-label"><i class="fas fa-balance-scale"></i> Final Cost</label>
            <input type="number" class="form-control" id="finalCost" name="finalCost" placeholder="Final Cost" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label"><i class="fas fa-credit-card me-2"></i> Payment Type</label>
            <div>
              <label class="form-check-label me-3">
                <input class="form-check-input" type="radio" name="paymentType" value="Paid" required> Paid
              </label>
              <label class="form-check-label me-3">
                <input class="form-check-input" type="radio" name="paymentType" value="Unpaid"> Unpaid
              </label>
              <label class="form-check-label">
                <input class="form-check-input" type="radio" name="paymentType" value="Other"> Other
              </label>
            </div>
          </div>

        </div>

        <!-- Hidden Field for Items -->
        <input type="hidden" name="itemsData" id="itemsData">

        <!-- Save Button -->
        <div class="text-center">
          <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-save me-2"></i> Save Purchase
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="ajax.js"></script>
  <script>
    // Load header.html into placeholder
    document.addEventListener("DOMContentLoaded", function() {
      fetch("header.html")
        .then(response => response.text())
        .then(data => {
          document.getElementById("header-placeholder").innerHTML = data;
        })
        .catch(error => console.error("Error loading header:", error));

      // AJAX Autocomplete setup
      if (typeof setupAutocomplete === "function") {
        setupAutocomplete("storeIncharge", "storeInchargeSuggestions", "store_incharge");
        setupAutocomplete("supplierName", "supplierNameSuggestions", "supplier_name");
        setupAutocomplete("supplierGst", "supplierGstSuggestions", "supplier_gst");
        setupAutocomplete("materialName", "materialNameSuggestions", "material_name");
        setupAutocomplete("materialCode", "materialCodeSuggestions", "material_code");
      }

      // Auto-fill GST and contact when supplier selected
      document.getElementById("supplierNameSuggestions").addEventListener("click", function(e) {
        const item = e.target.closest(".list-group-item-action");
        if (item && item.dataset.value) {
          fetch(`fetch_suggestions.php?field=supplier_gst_by_name&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(gst => {
              document.getElementById("supplierGst").value = gst;
            });
          fetch(`fetch_suggestions.php?field=supplier_contact_by_name&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(contact => {
              document.getElementById("contactNo").value = contact;
            });
        }
      });

      // Auto-fill supplier name when GST selected
      document.getElementById("supplierGstSuggestions").addEventListener("click", function(e) {
        const item = e.target.closest(".list-group-item-action");
        if (item && item.dataset.value) {
          fetch(`fetch_suggestions.php?field=supplier_name_by_gst&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(name => {
              document.getElementById("supplierName").value = name;
            });
          fetch(`fetch_suggestions.php?field=supplier_contact_by_gst&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(contact => {
              document.getElementById("contactNo").value = contact;
            });
        }
      });

      // Auto-fill material code/name
      document.getElementById("materialNameSuggestions").addEventListener("click", function(e) {
        const item = e.target.closest(".list-group-item-action");
        if (item && item.dataset.value) {
          fetch(`fetch_suggestions.php?field=material_code_by_name&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(code => {
              document.getElementById("materialCode").value = code;
            });
          // Autofill unit by material name
          fetch(`fetch_suggestions.php?field=material_unit_by_name&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(unit => {
              document.getElementById("materialUnit").value = unit;
            });
        }
      });
      document.getElementById("materialCodeSuggestions").addEventListener("click", function(e) {
        const item = e.target.closest(".list-group-item-action");
        if (item && item.dataset.value) {
          fetch(`fetch_suggestions.php?field=material_name_by_code&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(name => {
              document.getElementById("materialName").value = name;
            });
          // Autofill unit by material code
          fetch(`fetch_suggestions.php?field=material_unit_by_code&q=${encodeURIComponent(item.dataset.value)}`)
            .then(res => res.text())
            .then(unit => {
              document.getElementById("materialUnit").value = unit;
            });
        }
      });
    });

    let items = [];

    // Auto calculate total cost
      document.querySelectorAll("#materialQuantity, #rate,#gstPercent")
        .forEach(el => el.addEventListener("input", () => {
          const qty = +document.getElementById("materialQuantity").value || 0;
          const rate = +document.getElementById("rate").value || 0;
          const gstPercent = +document.getElementById("gstPercent").value || 0;
          const subtotal =qty *rate;
          const gstAmount = (subtotal *gstPercent)/100;
          
          document.getElementById("totalCost").value = (subtotal+gstAmount).toFixed(2);
        }));

    // Add Item
    document.getElementById("addItemBtn").addEventListener("click", () => {
      const qty = +document.getElementById("materialQuantity").value || 0;
      const rate = +document.getElementById("rate").value || 0;
      const gstPercent = +document.getElementById("gstPercent").value || 0;
      const subtotal = qty * rate;
      const gstAmount = (subtotal * gstPercent) / 100;

      const item = {
      name: document.getElementById("materialName").value,
      code: document.getElementById("materialCode").value,
      qty: document.getElementById("materialQuantity").value,
      unit: document.getElementById("materialUnit").value,
      location: document.getElementById("location").value,
      rate: document.getElementById("rate").value,
      gstPercent: gstPercent,
      gstAmount: gstAmount.toFixed(2),
      total: (subtotal + gstAmount).toFixed(2)
};

      if (!item.name || !item.code || !item.qty) {
        Swal.fire("Error", "Please fill at least Name, Code, and Quantity", "error");
        return;
      }

      items.push(item);
      renderItems();
      clearInputs();
    });

    // Render Items
    function renderItems() {
      const tbody = document.querySelector("#itemsTable tbody");
      tbody.innerHTML = "";
      let finalCost = 0;

      items.forEach((item, i) => {
        finalCost += +item.total;
        tbody.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td>${item.name}</td>
            <td>${item.code}</td>
            <td>${item.qty}</td>
            <td>${item.unit}</td>
            <td>${item.location}</td>
            <td>₹${item.rate}</td>
            <td>₹${item.gstPercent}%</td>
            <td>${item.gstAmount}</td>
            <td>₹${item.total}</td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${i})"><i class="fas fa-trash"></i></button></td>
          </tr>`;
      });

      document.getElementById("finalCost").value = finalCost.toFixed(2);
      document.getElementById("itemsData").value = JSON.stringify(items);
    }

    // Clear inputs
    function clearInputs() {
      ["materialName","materialCode","materialQuantity","materialUnit","location","rate","gstPercent","totalCost"]
      .forEach(id => document.getElementById(id).value = "");
    }

    // Remove Item
    function removeItem(i) {
      items.splice(i,1);
      renderItems();
    }
  </script>
</body>
</html>
